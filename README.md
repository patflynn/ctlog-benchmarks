# CT Log Benchmarks: Trillian vs. TesseraCT

[![Benchmark Status](https://github.com/patflynn/ctlog-benchmarks/actions/workflows/benchmark.yml/badge.svg)](https://github.com/patflynn/ctlog-benchmarks/actions/workflows/benchmark.yml)

A fully automated, reproducible benchmarking suite comparing the performance and cost-efficiency of [Trillian](https://github.com/google/trillian) (backed by Cloud SQL) and **TesseraCT** (backed by Spanner) on Google Cloud Platform.

## Latest Benchmark Results

> **Note:** These results are automatically generated by the [Benchmark Workflow](.github/workflows/benchmark.yml).

<!-- BENCHMARK-RESULTS-START -->
**Tier: large** — db-n1-standard-2 / Spanner 1000 PU / 3× e2-standard-4
  
*Last updated: 2026-02-02T02:33:38.769992+00:00*

| Metric | Trillian (MySQL) | TesseraCT (Spanner) |
| :--- | :--- | :--- |
| **Achieved QPS** | 9.65 | 46.43 |
| **Infra Cost/hr** | $0.4895 | $1.2840 |
| **Cost per 1M Entries** | $14.10 | $7.68 |
<!-- BENCHMARK-RESULTS-END -->

Cost model: deterministic from [`costs.json`](costs.json) (Terraform-derived infrastructure rates).

## Project Goals

1.  **Reproducibility:** The entire benchmark (Infrastructure -> Deploy -> Load Test -> Teardown) is a single GitHub Actions workflow.
2.  **Transparency:** Infrastructure costs are deterministic and auditable via [`costs.json`](costs.json), derived directly from the Terraform configuration — not delayed billing reports or error-prone metric queries.
3.  **Fairness:** Both systems run on the same GKE cluster and network path. Benchmarks include smoke tests and validation to ensure results reflect real throughput.

## Cost Model

Infrastructure costs are **fixed and known from Terraform** — see [`costs.json`](costs.json) for the full breakdown:

| Tier | GKE Nodes | Cloud SQL | Spanner | Trillian $/hr | TesseraCT $/hr |
|:---|:---|:---|:---|---:|---:|
| small | 2× e2-standard-2 | db-f1-micro | 100 PU | $0.1930 | $0.2680 |
| medium | 3× e2-standard-2 | db-n1-standard-1 | 300 PU | $0.2795 | $0.4995 |
| large | 3× e2-standard-4 | db-n1-standard-2 | 1000 PU | $0.4895 | $1.2840 |

**Cost per 1M entries** = (cost_per_hour / achieved_qps / 3600) × 1,000,000

## Architecture

This project uses a "GitOps-lite" approach where the repo contains everything needed to spin up a transient environment.

*   **Infrastructure:** Terraform (`/terraform`) manages the GKE cluster, Cloud SQL, Spanner, and GCS.
    *   *State:* Stored in GCS.
    *   *Bootstrap:* Long-lived auth resources (Workload Identity) are in `/terraform/bootstrap`.
*   **Deployment:** `ko` builds and pushes Go binaries directly to the cluster. Manifests are in `/k8s`.
*   **Orchestration:** Python scripts (`/scripts`) coordinate the benchmark:
    *   `deploy_k8s.sh`: Deploys the application stacks.
    *   `benchmark.py`: Runs smoke tests, then load generators (`ct_hammer` / `hammer`).
    *   `metrics.py`: Calculates costs from deterministic infrastructure pricing in `costs.json`.

## Running the Benchmark

This project is designed to run via **GitHub Actions**.

1.  Go to the **Actions** tab.
2.  Select the **Benchmark Execution** workflow.
3.  Click **Run workflow** (default: large tier, 50 QPS).

The workflow will:
1.  Authenticate to GCP and connect to the GKE cluster.
2.  Run smoke tests to verify both systems accept writes.
3.  Run load tests sequentially (Trillian, then TesseraCT).
4.  Calculate costs and open a Pull Request with results and full cost breakdown.

## Local Development

**Prerequisites:**
*   Go 1.24+
*   Terraform 1.9+
*   `ko`
*   `gcloud` CLI

**Bootstrap (One-time):**
The `terraform/bootstrap` directory sets up the Workload Identity that allows GitHub Actions to talk to GCP.
