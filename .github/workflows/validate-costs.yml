name: Validate Costs

on:
  workflow_dispatch:
    inputs:
      tier:
        description: 'Tier to validate (leave empty for all)'
        required: false
        default: ''
      threshold:
        description: 'Drift tolerance percentage'
        required: false
        default: '5.0'

permissions:
  contents: read

jobs:
  validate:
    name: Check GCP Price Drift
    runs-on: ubuntu-latest
    environment: BENCHMARKING

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'

    - name: Validate costs
      env:
        GOOGLE_API_KEY: ${{ secrets.GCP_BILLING_API_KEY }}
      run: |
        args="--threshold ${{ inputs.threshold }}"
        if [ -n "${{ inputs.tier }}" ]; then
          args="$args --tier ${{ inputs.tier }}"
        fi
        python3 scripts/validate_costs.py $args
