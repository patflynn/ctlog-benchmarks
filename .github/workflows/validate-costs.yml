name: Validate Costs

on:
  workflow_dispatch:
    inputs:
      tier:
        description: 'Tier to validate (leave empty for all)'
        required: false
        default: ''
      threshold:
        description: 'Drift tolerance percentage'
        required: false
        default: '5.0'

permissions:
  contents: read
  id-token: write

env:
  WIF_PROVIDER: ${{ vars.GCP_WIF_PROVIDER }}
  WIF_SERVICE_ACCOUNT: ${{ vars.GCP_WIF_SA }}

jobs:
  validate:
    name: Check GCP Price Drift
    runs-on: ubuntu-latest
    environment: BENCHMARKING

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Authenticate to Google Cloud
      uses: google-github-actions/auth@v3
      with:
        workload_identity_provider: ${{ env.WIF_PROVIDER }}
        service_account: ${{ env.WIF_SERVICE_ACCOUNT }}

    - name: Setup gcloud
      uses: google-github-actions/setup-gcloud@v2

    - name: Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'

    - name: Validate costs
      run: |
        args="--threshold ${{ inputs.threshold }}"
        if [ -n "${{ inputs.tier }}" ]; then
          args="$args --tier ${{ inputs.tier }}"
        fi
        python3 scripts/validate_costs.py $args
