name: Benchmark Execution

on:
  workflow_dispatch:
    inputs:
      duration:
        description: 'Duration in minutes per test'
        required: true
        default: '5'
      qps:
        description: 'Target QPS'
        required: true
        default: '500'

permissions:
  contents: write # To update README
  id-token: write

env:
  PROJECT_ID: ${{ vars.GCP_PROJECT_ID }}
  WIF_PROVIDER: ${{ vars.GCP_WIF_PROVIDER }}
  WIF_SERVICE_ACCOUNT: ${{ vars.GCP_WIF_SA }}
  REGION: us-central1
  ZONE: us-central1-a
  CLUSTER_NAME: ctlog-cluster

jobs:
  benchmark:
    name: Run Benchmark
    runs-on: ubuntu-latest
    environment: BENCHMARKING

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Authenticate to Google Cloud
      uses: google-github-actions/auth@v3
      with:
        workload_identity_provider: ${{ env.WIF_PROVIDER }}
        service_account: ${{ env.WIF_SERVICE_ACCOUNT }}

    - name: Setup GCloud & Kubectl
      uses: google-github-actions/setup-gcloud@v2
      with:
        project_id: ${{ env.PROJECT_ID }}
        install_components: 'gke-gcloud-auth-plugin'

    - name: Get Cluster Credentials
      uses: google-github-actions/get-gke-credentials@v2
      with:
        cluster_name: ${{ env.CLUSTER_NAME }}
        location: ${{ env.ZONE }}

    - name: Setup Go
      uses: actions/setup-go@v5
      with:
        go-version: '1.24'

    - name: Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        cache: 'pip'

    - name: Install Python Deps
      run: pip install -r scripts/requirements.txt

    - name: Run Benchmark Script
      id: bench
      run: |
        python3 scripts/benchmark.py 
          --project_id ${{ env.PROJECT_ID }} 
          --duration ${{ inputs.duration }} 
          --qps ${{ inputs.qps }} > benchmark_output.txt 2>&1
        
        cat benchmark_output.txt

    - name: Parse Results (Simple)
      if: success()
      run: |
        # Extract Costs from output
        TR_COST=$(grep "Trillian Cost:" benchmark_output.txt | awk '{print $3}')
        TE_COST=$(grep "TesseraCT Cost:" benchmark_output.txt | awk '{print $3}')
        
        echo "TR_COST=$TR_COST" >> $GITHUB_ENV
        echo "TE_COST=$TE_COST" >> $GITHUB_ENV

    - name: Update README
      if: success()
      uses: pattern-labs/update-readme-action@v2 # Generic placeholder or custom script
      continue-on-error: true # Don't fail if this step is tricky
      with:
        # We'll just use a simple sed command in the next step instead of an action
        pass: true

    - name: Commit Results to README
      if: success()
      run: |
        # Replace placeholders in README.md
        # This is a bit brittle, but works for the demo.
        # We look for the table and update pending values.
        # Ideally, use a marker.
        
        DATE=$(date +%Y-%m-%d)
        
        # We append a new row to a "History" file or just update the main table
        # Let's just create a RESULTS.md for now to be safe
        echo "## Benchmark Results ($DATE)" > RESULTS.md
        echo "| System | Duration | QPS | Cost |" >> RESULTS.md
        echo "|---|---|---|---|" >> RESULTS.md
        echo "| Trillian | ${{ inputs.duration }}m | ${{ inputs.qps }} | $TR_COST |" >> RESULTS.md
        echo "| TesseraCT | ${{ inputs.duration }}m | ${{ inputs.qps }} | $TE_COST |" >> RESULTS.md
        
        git config user.name "Benchmark Bot"
        git config user.email "bot@example.com"
        git add RESULTS.md
        git commit -m "Docs: Update benchmark results [$DATE]" || echo "No changes"
        git push
