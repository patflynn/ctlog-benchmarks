name: Benchmark Execution

on:
  workflow_dispatch:
    inputs:
      duration:
        description: 'Duration in minutes per test'
        required: true
        default: '5'
      qps:
        description: 'Target QPS'
        required: true
        default: '500'

permissions:
  contents: write # To update README
  pull-requests: write # To create PRs
  id-token: write

env:
  PROJECT_ID: ${{ vars.GCP_PROJECT_ID }}
  WIF_PROVIDER: ${{ vars.GCP_WIF_PROVIDER }}
  WIF_SERVICE_ACCOUNT: ${{ vars.GCP_WIF_SA }}
  REGION: us-central1
  ZONE: us-central1-a
  CLUSTER_NAME: ctlog-cluster

jobs:
  benchmark:
    name: Run Benchmark
    runs-on: ubuntu-latest
    environment: BENCHMARKING

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Authenticate to Google Cloud
      uses: google-github-actions/auth@v3
      with:
        workload_identity_provider: ${{ env.WIF_PROVIDER }}
        service_account: ${{ env.WIF_SERVICE_ACCOUNT }}

    - name: Setup GCloud & Kubectl
      uses: google-github-actions/setup-gcloud@v2
      with:
        project_id: ${{ env.PROJECT_ID }}
        install_components: 'gke-gcloud-auth-plugin'

    - name: Get Cluster Credentials
      uses: google-github-actions/get-gke-credentials@v2
      with:
        cluster_name: ${{ env.CLUSTER_NAME }}
        location: ${{ env.ZONE }}

    - name: Setup Go
      uses: actions/setup-go@v5
      with:
        go-version: '1.24'

    - name: Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        cache: 'pip'

    - name: Install Python Deps
      run: pip install -r scripts/requirements.txt

    - name: Run Benchmark Script
      id: bench
      run: |
        python3 scripts/benchmark.py \
          --project_id ${{ env.PROJECT_ID }} \
          --duration ${{ inputs.duration }} \
          --qps ${{ inputs.qps }} 2>&1 | tee benchmark_output.txt

    - name: Parse Results (Simple)
      if: success()
      run: |
        # Extract Costs from output
        TR_COST=$(grep "Trillian Cost:" benchmark_output.txt | awk '{print $3}')
        TE_COST=$(grep "TesseraCT Cost:" benchmark_output.txt | awk '{print $3}')
        
        echo "TR_COST=$TR_COST" >> $GITHUB_ENV
        echo "TE_COST=$TE_COST" >> $GITHUB_ENV

    - name: Publish Results
      if: success()
      continue-on-error: true
      run: |
        DATE=$(date +%Y-%m-%d)
        
        # 1. Create content
        echo "## Benchmark Results ($DATE)" > RESULTS.md
        echo "| System | Duration | QPS | Cost |" >> RESULTS.md
        echo "|---|---|---|---|" >> RESULTS.md
        echo "| Trillian | ${{ inputs.duration }}m | ${{ inputs.qps }} | $TR_COST |" >> RESULTS.md
        echo "| TesseraCT | ${{ inputs.duration }}m | ${{ inputs.qps }} | $TE_COST |" >> RESULTS.md
        
        # 2. Write to Job Summary (Visible in Actions UI)
        cat RESULTS.md >> $GITHUB_STEP_SUMMARY

    - name: Create Pull Request
      if: success()
      uses: peter-evans/create-pull-request@v6
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        commit-message: "Docs: Update benchmark results"
        title: "Benchmark Results: ${{ inputs.duration }}m @ ${{ inputs.qps }} QPS"
        body: |
          Automated benchmark results.
          
          | System | Duration | QPS | Cost |
          |---|---|---|---|
          | Trillian | ${{ inputs.duration }}m | ${{ inputs.qps }} | ${{ env.TR_COST }} |
          | TesseraCT | ${{ inputs.duration }}m | ${{ inputs.qps }} | ${{ env.TE_COST }} |
        branch: "benchmark-results-${{ github.run_id }}"
        base: main
        add-paths: |
          RESULTS.md
